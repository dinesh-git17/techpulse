# Protocol Zero Compliance Scanner

Enforcement suite for detecting and blocking AI attribution references in source code and commit messages.

## Overview

This tooling enforces a "Zero Attribution" policy, ensuring that no artifacts contain semantic references to Generative AI tools or vendors. The suite consists of:

- **scan_content.py**: Recursive file scanner for repository content
- **scan_message.py**: Commit message validator
- **config.yaml**: Centralized policy definition

## Requirements

- Python 3.9+
- PyYAML (standard in most Python installations)
- No additional dependencies required

## Usage

### Scanning Repository Content

```bash
python tools/compliance/scan_content.py <directory>
```

Example:
```bash
python tools/compliance/scan_content.py ./src
```

The scanner will:
1. Recursively traverse the directory
2. Filter files by configured extensions
3. Skip ignored directories and symbolic links
4. Report all violations with file path, line number, and matched text

### Validating Commit Messages

```bash
python tools/compliance/scan_message.py <commit_message_file>
```

Example (Git hook usage):
```bash
python tools/compliance/scan_message.py .git/COMMIT_EDITMSG
```

The validator will:
1. Read the commit message file
2. Strip git comment lines (starting with `#`)
3. Check content against the denylist
4. Block the commit if violations are found

## Exit Codes

| Code | Meaning |
|------|---------|
| `0`  | Success - No violations detected |
| `1`  | Violation found - Operation blocked |
| `2`  | Script error - Configuration or file access issue |

## Configuration

Policy rules are defined in `config.yaml`. The configuration file is loaded relative to the script location.

### Structure

```yaml
denylist:
  - pattern: "\\bpattern\\b"      # Raw regex pattern
    description: "Rule description"
    exceptions: ["filename.py"]   # Optional: files to exclude (filename only)

extensions_to_scan:
  - .py
  - .js
  - .ts

ignore_dirs:
  - node_modules
  - .git
```

### Adding New Rules

To add a new blocked term:

1. Open `config.yaml`
2. Add an entry to the `denylist` section:

```yaml
denylist:
  - pattern: "\\bnew-term\\b"
    description: "Description of why this is blocked"
```

### Regex Pattern Syntax

Patterns use Python regex syntax with the following considerations:

- **Word boundaries**: Use `\\b` to match whole words only
  - `\\bchatgpt\\b` matches "chatgpt" but not "mychatgptbot"
- **Case insensitivity**: All matching is case-insensitive automatically
- **Special characters**: Escape regex metacharacters with `\\`
  - Match "gpt-4": `\\bgpt-4\\b`
  - Match "ai.tool": `\\bai\\.tool\\b`
- **Whitespace**: Use `\\s+` for flexible whitespace matching
  - `\\bai\\s+assisted\\b` matches "ai assisted" and "ai  assisted"

### Common Pattern Examples

| Pattern | Matches | Does Not Match |
|---------|---------|----------------|
| `\\bchatgpt\\b` | "ChatGPT", "chatgpt" | "mychatgptbot" |
| `\\bgpt-4\\b` | "GPT-4", "gpt-4" | "gpt4", "gpt-40" |
| `\\bai\\s+assisted\\b` | "AI assisted", "ai  assisted" | "aiassisted" |
| `\\bgenerated\\s+by\\s+ai\\b` | "generated by AI" | "autogenerated" |

### Exceptions

Exceptions allow specific files to bypass certain rules. Exceptions match by **filename only**, not full path:

```yaml
denylist:
  - pattern: "\\bcopilot\\b"
    description: "Copilot reference"
    exceptions: ["copilot_service.py"]  # Any file with this name is exempt
```

## Output Format

### Content Scanner Output

```
[PROTOCOL ZERO VIOLATION]
------------------------------------------------------------
FILE:    src/utils/helper.ts
LINE:    42
MATCH:   "ChatGPT"
RULE:    OpenAI ChatGPT Product
------------------------------------------------------------
Action: Remove the attribution and retry.
```

### Commit Message Scanner Output

```
[PROTOCOL ZERO VIOLATION]
============================================================
COMMIT REJECTED: AI attribution detected in commit message
============================================================

Violations found:
  Line 3: "ChatGPT"
    Rule: OpenAI ChatGPT Product
    Context: Used ChatGPT for implementation

------------------------------------------------------------
Action: Remove AI attribution references and retry commit.
```

## Running Tests

Execute the test suite from the repository root:

```bash
python -m unittest discover -s tools/compliance/tests -v
```

Or run individual test files:

```bash
python -m unittest tools/compliance/tests/test_scan_content -v
python -m unittest tools/compliance/tests/test_scan_message -v
```

## Integration Notes

### Pre-commit Hook

Add to `.git/hooks/commit-msg`:

```bash
#!/bin/sh
python tools/compliance/scan_message.py "$1"
```

### CI Pipeline

Add as a blocking step in your CI configuration:

```yaml
- name: Protocol Zero Check
  run: python tools/compliance/scan_content.py ./src ./frontend
```

## Behavior Details

### Symbolic Links

Symbolic links are **skipped entirely** during traversal. This prevents:
- Infinite loops from circular symlinks
- Duplicate scanning of the same content
- Security issues from symlink attacks

### Encoding Errors

Files that cannot be decoded as UTF-8 are **skipped with a warning** to stderr. Scanning continues with remaining files.

### Multiple Matches

When a single line contains multiple violations, **all matches are reported separately**. This ensures developers see everything requiring remediation in a single pass.

### Unicode Normalization

Content is normalized using NFKC before matching. This prevents bypasses using:
- Fullwidth characters (e.g., `ChatGPT`)
- Unicode homoglyphs (e.g., Cyrillic characters)
